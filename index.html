<html>
<head>
  <title>US Olympic Athletics Medals Over Time</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://unpkg.com/d3-svg-annotation@2.5.1/d3-annotation.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      display: flex;
      justify-content: center;
    }
    svg {
      font-size: 12px;
    }
    .line {
      fill: none;
      stroke-width: 2.5px;
      cursor: pointer;
    }
    .dot {
      stroke: white;
      stroke-width: 1px;
    }
    .blurred {
      opacity: 0.2;
    }
    .legend {
      cursor: pointer;
    }
    .blurb {
      font-size: 12px;
      font-weight: 500;
      padding: 5px;
      border-radius: 5px;
      background-color: #f5f5f5;
    }
    .subtitle {
      font-size: 14px;
      fill: #666;
    }
  </style>
</head>
<body>
  <script>
    const width = 900;
    const height = 500;
    const margin = { top: 80, right: 240, bottom: 50, left: 60 };
    const innerWidth = width - margin.left - margin.right;
    const innerHeight = height - margin.top - margin.bottom;
    const colorMap = { Total: "#1f77b4", Gold: "#ffd700", Silver: "#c0c0c0", Bronze: "#cd7f32" };
    const medals = ["Total", "Gold", "Silver", "Bronze"];
    const blurbs = {
      Total: "Click on the lines to see a breakdown by medal type. Hover ower the points to see a breakdown event by event",
      Gold: "Gold medals consistently contribute the highest number of medals to the total tally",
      Silver: "The Silver medal tally generally moves opposite to the gold medals, ensuring that the total tally remains stable",
      Bronze: "Apart from the outlier in 1904 team USA has won a consistent amount of bronze medals"
    };

    const svg = d3.select("body").append("svg")
      .attr("viewBox", [0, 0, width, height])
      .append("g")
      .attr("transform", `translate(${margin.left},${margin.top})`);

    svg.append("text")
      .attr("x", innerWidth/2)
      .attr("y", -40)
      .attr("text-anchor", "middle")
      .style("font-size", "24px")
      .text("Medals Over Time for US Olympic Athletics");

    svg.append("text")
      .attr("x", innerWidth/2)
      .attr("y", -20)
      .attr("text-anchor", "middle")
      .attr("class", "subtitle")
      .text("Barring some outliers the tally across over a century has remained remarkably stable");

    const blurb = svg.append("foreignObject")
      .attr("x", innerWidth-200)
      .attr("y", -10)
      .attr("width", 180)
      .attr("height", 100)
      .append("xhtml:div")
      .attr("class", "blurb")
      .style("background-color", "#1f77b420")
      .text("Click on the lines to see a breakdown by medal type. Hover ower the points to see a breakdown event by event");

    d3.csv("all_us_athletics.csv").then(data => {
      data = data.filter(d => d.sport === "Athletics" && d.country_code === "USA");

      const medalsByYear = d3.rollup(
        data,
        v => ({
          Total: v.length,
          Gold: v.filter(d => d.medal === "Gold").length,
          Silver: v.filter(d => d.medal === "Silver").length,
          Bronze: v.filter(d => d.medal === "Bronze").length,
          Events: d3.rollups(v, g => g.length, d => d.event_name)
        }), d => +d.year
      );

      const years = Array.from(medalsByYear.keys()).sort((a, b) => a - b);
      const medalCounts = years.map(year => ({ Year: year, ...medalsByYear.get(year) }));

      const xScale = d3.scaleLinear().domain(d3.extent(years)).range([0, innerWidth]);
      const yScale = d3.scaleLinear().domain([0, d3.max(medalCounts, d => d.Total)]).nice().range([innerHeight, 0]);
      const xAxis = g => g.attr("transform", `translate(0,${innerHeight})`).call(d3.axisBottom(xScale).tickFormat(d3.format("d")));
      const yAxis = g => g.call(d3.axisLeft(yScale));
      svg.append("g").call(xAxis);
      svg.append("g").call(yAxis);

      svg.append("text").attr("x", innerWidth/2).attr("y", innerHeight+40).attr("text-anchor", "middle").text("Year");
      svg.append("text").attr("transform", "rotate(-90)").attr("x", -innerHeight/2).attr("y", -40).attr("text-anchor", "middle").text("Number of Medals");

      const line = d3.line().x(d => xScale(d.Year)).y((d, i, nodes) => yScale(d[nodes[i].unused]))

      let selectedMedal = "Total";

      const medalLines = svg.selectAll(".line")
        .data(medals)
        .join("path")
        .attr("class", "line")
        .attr("stroke", d => colorMap[d])
        .attr("d", d => {
          const path = d3.line()
            .x(p => xScale(p.Year))
            .y(p => yScale(p[d]))(medalCounts);
          return path;
        })
        .attr("fill", "none")
        .classed("blurred", d => d !== "Total");

      svg.selectAll(".dot")
        .data(medals.flatMap(m => medalCounts.map(d => ({ medal: m, Year: d.Year, value: d[m], Events: d.Events }))))
        .join("circle")
        .attr("class", "dot")
        .attr("r", 3)
        .attr("cx", d => xScale(d.Year))
        .attr("cy", d => yScale(d.value))
        .attr("fill", d => colorMap[d.medal])
        .attr("opacity", d => d.medal === "Total" ? 1:0.3)
        .on("mouseover", function (event, d) {
          if (selectedMedal && selectedMedal !== d.medal) return;
          const sortedEvents = d.Events.sort((a, b) => b[1] - a[1]);
          const tooltipHtml = `${d.medal} medals in ${d.Year}:<br>` + sortedEvents.map(([name, count]) => `${name}: ${count}`).join("<br>");
          d3.select("#tooltip").style("opacity", 1).html(tooltipHtml).style("left", event.pageX + 10 + "px").style("top", event.pageY - 28 + "px");
        })
        .on("mouseout", () => d3.select("#tooltip").style("opacity", 0));

      svg.selectAll(".legend")
        .data(medals)
        .enter().append("text")
        .attr("class", "legend")
        .attr("x", innerWidth+10)
        .attr("y", (d, i) => 30+i*20)
        .attr("fill", d => colorMap[d])
        .text(d => d)
        .on("click", (_, d) => updateSelection(d));

      medalLines.on("mouseover", function (_, d) {
          if (selectedMedal !== d) d3.select(this).attr("stroke-width", 4);
        })
        .on("mouseout", function (_, d) {
          if (selectedMedal !== d) d3.select(this).attr("stroke-width", 2.5);
        })
        .on("click", (_, d) => updateSelection(d));

      function updateSelection(medal) {
        selectedMedal = medal;
        blurb.text(blurbs[medal]).style("background-color", colorMap[medal]+"20");
        svg.selectAll(".line").classed("blurred", d => d !== medal);
        svg.selectAll(".dot").attr("opacity", d => d.medal === medal ? 1 : 0.1);
      }

      const annotations = d3.annotation()
        .type(d3.annotationLabel)
        .annotations([
          {
            note: { label: "Limited international participation and a large contingent of American athletes led to this record breaking medal tally", title: "1904" },
            x: xScale(1904), y: yScale(medalCounts.find(d => d.Year === 1904).Total),
            dx: 30, dy: 30,
            subject: { radius: 10, radiusPadding: 1 },
            type: d3.annotationCalloutCircle
          },
          {
            note: { label: "The Soviet Boycott of the games meant that some of the strongest athletic teams were not present", title: "1984" },
            x: xScale(1984), y: yScale(medalCounts.find(d => d.Year === 1984).Total),
            dx: 20, dy: -1,
            subject: { radius: 10, radiusPadding: 1 },
            type: d3.annotationCalloutCircle
          }
        ]);

      svg.append("g")
        .attr("class", "annotation-group")
        .call(annotations);
    });

    d3.select("body").append("div")
      .attr("id", "tooltip")
      .style("position", "absolute")
      .style("text-align", "left")
      .style("padding", "8px")
      .style("font-size", "12px")
      .style("background", "lightsteelblue")
      .style("border", "1px solid #ccc")
      .style("border-radius", "4px")
      .style("pointer-events", "none")
      .style("opacity", 0);
  </script>
</body>
</html>
